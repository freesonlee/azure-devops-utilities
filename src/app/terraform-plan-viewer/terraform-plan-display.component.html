<div class="container" *ngIf="plan">
    <!-- Plan Overview -->
    <mat-card class="overview-card">
        <mat-card-header>
            <mat-card-title>Plan Overview</mat-card-title>
            <mat-card-subtitle>Terraform {{ plan.terraform_version }} â€¢ Format {{ plan.format_version
                }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <div class="stats-grid">
                <div class="stat-item create clickable-stat" (click)="onStatButtonClick('create')">
                    <mat-icon>add_circle</mat-icon>
                    <div class="stat-content">
                        <div class="stat-number">{{ resourceSummary.create }}</div>
                        <div class="stat-label">Create</div>
                    </div>
                </div>
                <div class="stat-item update clickable-stat" (click)="onStatButtonClick('update')">
                    <mat-icon>edit</mat-icon>
                    <div class="stat-content">
                        <div class="stat-number">{{ resourceSummary.update }}</div>
                        <div class="stat-label">Update</div>
                    </div>
                </div>
                <div class="stat-item delete clickable-stat" (click)="onStatButtonClick('delete')">
                    <mat-icon>delete</mat-icon>
                    <div class="stat-content">
                        <div class="stat-number">{{ resourceSummary.delete }}</div>
                        <div class="stat-label">Delete</div>
                    </div>
                </div>
                <div class="stat-item replace clickable-stat" (click)="onStatButtonClick('replace')">
                    <mat-icon>swap_horiz</mat-icon>
                    <div class="stat-content">
                        <div class="stat-number">{{ resourceSummary.replace }}</div>
                        <div class="stat-label">Replace</div>
                    </div>
                </div>
                <div class="stat-item changes clickable-stat" (click)="onStatButtonClick('changes')">
                    <mat-icon>published_with_changes</mat-icon>
                    <div class="stat-content">
                        <div class="stat-number">{{ resourceSummary.changes }}</div>
                        <div class="stat-label">Changes</div>
                    </div>
                </div>
                <div class="stat-item total clickable-stat" (click)="onStatButtonClick('total')">
                    <mat-icon>list</mat-icon>
                    <div class="stat-content">
                        <div class="stat-number">{{ resourceSummary.total }}</div>
                        <div class="stat-label">Total</div>
                    </div>
                </div>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Tabs for different views -->
    <mat-card class="content-card">
        <mat-tab-group #tabGroup>
            <!-- Resources Tab -->
            <mat-tab label="Resources ({{ getFilteredResourceCount() }})">
                <div class="tab-content">
                    <!-- Filter indication -->
                    <mat-card class="filter-card" *ngIf="activeResourceFilter || resourceSearchFilter"
                        style="margin-bottom: 16px;">
                        <mat-card-content>
                            <div class="filter-controls">
                                <mat-chip-set>
                                    <mat-chip *ngIf="activeResourceFilter"
                                        [style.background-color]="getActionColor([activeResourceFilter])"
                                        [style.color]="'white'" [removable]="true" (removed)="clearResourceFilter()">
                                        <mat-icon [style.font-size]="'16px'">{{
                                            getActionIcon([activeResourceFilter])
                                            }}</mat-icon>
                                        Showing {{ activeResourceFilter }} resources
                                        <mat-icon matChipRemove>cancel</mat-icon>
                                    </mat-chip>
                                    <mat-chip *ngIf="resourceSearchFilter"
                                        style="background-color: #2196f3; color: white;" [removable]="true"
                                        (removed)="clearResourceSearchFilter()">
                                        <mat-icon [style.font-size]="'16px'">search</mat-icon>
                                        Search: "{{ resourceSearchFilter }}"
                                        <mat-icon matChipRemove>cancel</mat-icon>
                                    </mat-chip>
                                </mat-chip-set>
                                <div class="results-info">
                                    <span>Showing {{ getFilteredResourceCount() }} resources</span>
                                </div>
                            </div>
                        </mat-card-content>
                    </mat-card>

                    <!-- Search Bar -->
                    <div class="search-controls" style="margin-bottom: 16px;">
                        <mat-form-field appearance="outline" style="width: 100%;">
                            <mat-label>Search resources...</mat-label>
                            <input matInput [(ngModel)]="resourceSearchFilter"
                                placeholder="Search by address, type, or provider">
                            <mat-icon matSuffix>search</mat-icon>
                            <button matSuffix mat-icon-button *ngIf="resourceSearchFilter"
                                (click)="clearResourceSearchFilter()" aria-label="Clear search">
                                <mat-icon>close</mat-icon>
                            </button>
                        </mat-form-field>
                    </div>

                    <!-- Split Layout Container -->
                    <div class="split-container">
                        <!-- Left Panel - Resource List -->
                        <div class="left-panel">

                            <!-- View Toggle (for CDKTF stacks) -->
                            <div class="view-toggle-container" *ngIf="isCdktfStack()">
                                <div class="view-toggle-wrapper">
                                    <span class="view-label" [class.active]="!showConstructView">Terraform view</span>
                                    <div class="custom-toggle" (click)="toggleViewMode()">
                                        <div class="toggle-track">
                                            <div class="toggle-dot" [class.right]="showConstructView"></div>
                                        </div>
                                    </div>
                                    <span class="view-label" [class.active]="showConstructView">Construct view</span>
                                </div>
                            </div>

                            <!-- Terraform View (Traditional) -->
                            <div *ngIf="!showConstructView" class="terraform-view">
                                <app-resource-list [moduleGroups]="getFilteredModuleGroups()"
                                    [resourcesByModuleWithIterators]="resourcesByModuleWithIterators"
                                    [selectedResource]="selectedResource" [activeResourceFilter]="activeResourceFilter"
                                    [searchFilter]="resourceSearchFilter" (resourceSelected)="selectResource($event)"
                                    (searchFilterChanged)="resourceSearchFilter = $event">
                                </app-resource-list>
                            </div>

                            <!-- Construct View (CDKTF) -->
                            <div *ngIf="showConstructView && hasConstructTree()" class="construct-view">
                                <app-construct-view [rootChildren]="getConstructTreeRootChildren()"
                                    [rootDirectResources]="getConstructTreeRootDirectResources()"
                                    [selectedResource]="selectedResource" [searchFilter]="resourceSearchFilter"
                                    [activeResourceFilter]="activeResourceFilter" [showFullPath]="false"
                                    (resourceSelected)="selectResource($event)"
                                    (constructToggled)="onConstructToggled($event)">
                                </app-construct-view>
                            </div>

                            <!-- Construct View - No Tree Available -->
                            <div *ngIf="showConstructView && !hasConstructTree()" class="no-construct-tree">
                                <mat-card class="info-card">
                                    <mat-card-content>
                                        <div class="info-content">
                                            <mat-icon class="large-icon">info</mat-icon>
                                            <h3>Construct Tree Not Available</h3>
                                            <p>CDKTF construct hierarchy could not be built from the provided metadata.
                                            </p>
                                            <div class="debug-info"
                                                style="background: #f5f5f5; padding: 12px; margin: 12px 0; border-radius: 4px; font-family: monospace; font-size: 12px;">
                                                <strong>Debug Info:</strong><br>
                                                Stack Type: {{ stackType }}<br>
                                                Has Plan: {{ !!plan }}<br>
                                                Has CDKTF JSON: {{ !!cdkTfJson }}<br>
                                                Resource Changes: {{ (plan && plan.resource_changes) ?
                                                plan.resource_changes.length : 0 }}<br>
                                                <div *ngIf="cdkTfJson" style="margin-top: 8px;">
                                                    CDKTF Keys: {{ getCdkTfJsonKeys() }}<br>
                                                    Has Resources: {{ !!cdkTfJson.resource }}
                                                </div>
                                            </div>
                                            <p class="help-text">
                                                <mat-icon>lightbulb</mat-icon>
                                                Switch to Terraform View to see resources grouped by modules and types.
                                                Check browser console for detailed debugging.
                                            </p>
                                            <button mat-raised-button color="primary" (click)="toggleViewMode()">
                                                <mat-icon>view_module</mat-icon>
                                                Switch to Terraform View
                                            </button>
                                        </div>
                                    </mat-card-content>
                                </mat-card>
                            </div>

                            <!-- Legacy Module Groups (fallback - remove this section after testing) -->
                            <mat-accordion
                                *ngFor="let moduleGroup of getFilteredModuleGroups(); trackBy: trackByModuleGroup"
                                class="module-accordion" style="display: none;">
                                <mat-expansion-panel class="module-panel">
                                    <mat-expansion-panel-header>
                                        <mat-panel-title class="module-title">
                                            <mat-icon class="module-icon">folder</mat-icon>
                                            {{ moduleGroup.display_name }}
                                        </mat-panel-title>
                                        <mat-panel-description class="module-description">
                                            {{ getFilteredModuleResourceCount(moduleGroup) }} resources
                                        </mat-panel-description>
                                    </mat-expansion-panel-header>

                                    <!-- Resources grouped by type within the module with iterator support -->
                                    <div class="module-content">
                                        <mat-accordion *ngFor="
                    let entry of getFilteredResourcesByModuleWithIterators().get(moduleGroup.name) | keyvalue;
                    trackBy: trackByResourceTypeGroup
                  " class="resource-type-accordion">
                                            <mat-expansion-panel class="resource-type-panel">
                                                <mat-expansion-panel-header>
                                                    <mat-panel-title class="resource-type-title">
                                                        {{ entry.value.display_name }}
                                                    </mat-panel-title>
                                                    <mat-panel-description class="resource-type-description">
                                                        {{ entry.value.total_count }} resources
                                                        <span *ngIf="getFilteredIteratorGroupsCount(entry.value) > 0"
                                                            class="iterator-group-indicator">
                                                            ({{ getFilteredIteratorGroupsCount(entry.value) }} groups)
                                                        </span>
                                                    </mat-panel-description>
                                                </mat-expansion-panel-header>

                                                <!-- Individual resources (non-iterator) -->
                                                <div *ngIf="entry.value.resources.length > 0" class="resource-list">
                                                    <div *ngFor="let resource of entry.value.resources"
                                                        class="resource-item"
                                                        [class.selected]="isResourceSelected(resource)"
                                                        (click)="selectResource(resource)">
                                                        <div class="resource-header">
                                                            <div class="resource-address">
                                                                <code>{{ resource.address }}</code>
                                                            </div>
                                                            <div class="resource-actions">
                                                                <mat-chip *ngFor="let action of resource.change.actions"
                                                                    [style.background-color]="getActionColor([action])"
                                                                    [style.color]="'white'" class="action-chip">
                                                                    <mat-icon [style.font-size]="'14px'">{{
                                                                        getActionIcon([action])
                                                                        }}</mat-icon>
                                                                    {{ action }}
                                                                </mat-chip>
                                                            </div>
                                                        </div>
                                                        <div class="resource-meta">
                                                            <span class="resource-type">{{ resource.type }}</span>
                                                            <span class="resource-provider">{{ resource.provider_name
                                                                }}</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Iterator groups -->
                                                <div *ngIf="entry.value.iterator_groups.length > 0"
                                                    class="iterator-groups">
                                                    <ng-container
                                                        *ngFor="let iteratorGroup of entry.value.iterator_groups; trackBy: trackByIteratorGroup">
                                                        <!-- Single instance: show directly without expansion panel -->
                                                        <div *ngIf="iteratorGroup.resources.length === 1"
                                                            class="resource-list">
                                                            <div *ngFor="let resource of iteratorGroup.resources"
                                                                class="resource-item"
                                                                [class.selected]="isResourceSelected(resource)"
                                                                (click)="selectResource(resource)">
                                                                <div class="resource-header">
                                                                    <div class="resource-address">
                                                                        <code>{{ resource.address }}</code>
                                                                    </div>
                                                                    <div class="resource-actions">
                                                                        <mat-chip
                                                                            *ngFor="let action of resource.change.actions"
                                                                            [style.background-color]="getActionColor([action])"
                                                                            [style.color]="'white'" class="action-chip">
                                                                            <mat-icon [style.font-size]="'14px'">{{
                                                                                getActionIcon([action])
                                                                                }}</mat-icon>
                                                                            {{ action }}
                                                                        </mat-chip>
                                                                    </div>
                                                                </div>
                                                                <div class="resource-meta">
                                                                    <span class="resource-type">{{ resource.type
                                                                        }}</span>
                                                                    <span class="resource-provider">{{
                                                                        resource.provider_name }}</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Multiple instances: show with expansion panel -->
                                                        <mat-accordion *ngIf="iteratorGroup.resources.length > 1"
                                                            class="iterator-group-accordion">
                                                            <mat-expansion-panel class="iterator-group-panel">
                                                                <mat-expansion-panel-header>
                                                                    <mat-panel-title class="iterator-group-title">
                                                                        <mat-icon class="iterator-icon">
                                                                            {{ iteratorGroup.iterator_type === 'count' ?
                                                                            'format_list_numbered' : 'view_list' }}
                                                                        </mat-icon>
                                                                        <code>{{ iteratorGroup.base_address }}</code>
                                                                    </mat-panel-title>
                                                                    <mat-panel-description
                                                                        class="iterator-group-description">
                                                                        {{ iteratorGroup.resources.length }} instances
                                                                        ({{ iteratorGroup.iterator_type }})
                                                                    </mat-panel-description>
                                                                </mat-expansion-panel-header>

                                                                <div class="resource-list iterator-resource-list">
                                                                    <div *ngFor="let resource of iteratorGroup.resources"
                                                                        class="resource-item iterator-resource-item"
                                                                        [class.selected]="isResourceSelected(resource)"
                                                                        (click)="selectResource(resource)">
                                                                        <div class="resource-header">
                                                                            <div class="resource-address">
                                                                                <code>{{ resource.address }}</code>
                                                                            </div>
                                                                            <div class="resource-actions">
                                                                                <mat-chip
                                                                                    *ngFor="let action of resource.change.actions"
                                                                                    [style.background-color]="getActionColor([action])"
                                                                                    [style.color]="'white'"
                                                                                    class="action-chip">
                                                                                    <mat-icon
                                                                                        [style.font-size]="'14px'">{{
                                                                                        getActionIcon([action])
                                                                                        }}</mat-icon>
                                                                                    {{ action }}
                                                                                </mat-chip>
                                                                            </div>
                                                                        </div>
                                                                        <div class="resource-meta">
                                                                            <span class="resource-type">{{ resource.type
                                                                                }}</span>
                                                                            <span class="resource-provider">{{
                                                                                resource.provider_name }}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </mat-expansion-panel>
                                                        </mat-accordion>
                                                    </ng-container>
                                                </div>
                                            </mat-expansion-panel>
                                        </mat-accordion>
                                    </div>
                                </mat-expansion-panel>
                            </mat-accordion>
                        </div>

                        <!-- Right Panel - Resource Details -->
                        <div class="right-panel">
                            <div *ngIf="!selectedResource" class="no-selection">
                                <mat-icon class="large-icon">info</mat-icon>
                                <h3>Select a Resource</h3>
                                <p>Click on a resource from the left panel to view its detailed changes.</p>
                            </div>

                            <div *ngIf="selectedResource" class="resource-details">

                                <!-- Resource Header -->
                                <div class="detail-header">
                                    <h3>
                                        <code>{{ selectedResource.address }}</code>
                                    </h3>
                                    <div class="resource-info-bar">
                                        <mat-chip>{{ selectedResource.type }}</mat-chip>
                                        <span class="provider-name">{{ selectedResource.provider_name }}</span>
                                    </div>
                                </div>

                                <!-- Action Buttons (Normal Mode Only) -->
                                <div class="resource-action-buttons" *ngIf="mode === 'normal'">
                                    <button mat-stroked-button color="primary" (click)="onTargetResource()"
                                        matTooltip="Target this specific resource for refresh">
                                        <mat-icon>my_location</mat-icon>
                                        Target this resource
                                    </button>

                                    <button mat-stroked-button color="primary" *ngIf="selectedResourceBelongsToBucket()"
                                        (click)="onTargetBucket()"
                                        [matTooltip]="'Target the entire bucket: ' + getSelectedResourceBucketName() + ' (' + getSelectedResourceBucketCount() + ' resources)'">
                                        <mat-icon>folder_special</mat-icon>
                                        Target "{{ getSelectedResourceBucketName() }}"
                                    </button>

                                    <button mat-stroked-button color="accent" *ngIf="isSelectedResourceToBeCreated()"
                                        (click)="onImportState()"
                                        matTooltip="Import existing resource into Terraform state">
                                        <mat-icon>file_download</mat-icon>
                                        Import
                                    </button>

                                    <button mat-stroked-button color="warn" *ngIf="isSelectedResourceToBeDeleted()"
                                        (click)="onRemoveFromState()"
                                        matTooltip="Remove resource from Terraform state without destroying">
                                        <mat-icon>delete_sweep</mat-icon>
                                        Remove from state
                                    </button>
                                </div>

                                <!-- Change Details Section -->
                                <div class="change-details" *ngIf="hasChanges(selectedResource)">
                                    <h4>
                                        <mat-icon>compare_arrows</mat-icon>
                                        Change Details
                                    </h4>

                                    <!-- Actions Summary -->
                                    <div class="actions-summary">
                                        <div class="actions-chips">
                                            <mat-chip-set>
                                                <mat-chip *ngFor="let action of selectedResource.change.actions"
                                                    [style.background-color]="getActionColor([action])"
                                                    [style.color]="'white'">
                                                    <mat-icon [style.font-size]="'16px'">{{
                                                        getActionIcon([action])
                                                        }}</mat-icon>
                                                    {{ action }}
                                                </mat-chip>
                                            </mat-chip-set>
                                        </div>
                                    </div>

                                    <!-- Field Changes -->
                                    <div class="field-changes">
                                        <mat-accordion>
                                            <mat-expansion-panel *ngFor="
                          let change of getSortedChangedFieldsWithDrift(selectedResource);
                          trackBy: trackByFieldChange
                        " [class.changed-field]="change.value.changed" [class.drifted-field]="change.value.hasDrift">
                                                <mat-expansion-panel-header>
                                                    <mat-panel-title>
                                                        <mat-icon
                                                            [style.color]="change.value.changed ? '#ff9800' : (change.value.hasDrift ? '#2196f3' : '#4caf50')"
                                                            [style.margin-right.px]="8">
                                                            {{ change.value.changed ? 'edit' : (change.value.hasDrift ?
                                                            'compare_arrows' : 'check_circle') }}
                                                        </mat-icon>
                                                        <code class="field-name">{{ change.key }}</code>
                                                    </mat-panel-title>
                                                    <mat-panel-description>
                                                        {{ change.value.changed ? 'Modified' : (change.value.hasDrift ?
                                                        'Drift Detected' : 'Unchanged') }}
                                                        <span
                                                            *ngIf="isPropertyForceReplacement(selectedResource, change.key)"
                                                            class="force-replacement-indicator">
                                                            force replacement
                                                        </span>
                                                    </mat-panel-description>
                                                </mat-expansion-panel-header>

                                                <div class="change-comparison"
                                                    *ngIf="change.value.changed || change.value.hasDrift">
                                                    <!-- Object property differences with drift support -->
                                                    <div *ngIf="
                              shouldShowObjectDiffWithDrift(change.value.before, change.value.current, change.value.after);
                              else simpleComparisonWithDrift
                            " class="object-diff-container">
                                                        <div class="diff-header">
                                                            <h5>
                                                                <mat-icon color="accent">data_object</mat-icon>
                                                                Property Changes
                                                                <span
                                                                    *ngIf="change.value.hasDrift && hasResourceDrift(selectedResource.address)"
                                                                    class="drift-indicator">
                                                                    <mat-icon color="primary"
                                                                        [matTooltip]="'Current state differs from planned state'">info</mat-icon>
                                                                    Drift Detected
                                                                </span>
                                                            </h5>
                                                        </div>

                                                        <div class="object-property-diff">
                                                            <div class="property-diff-header"
                                                                [class.three-column]="hasResourceDrift(selectedResource.address)">
                                                                <div class="property-name-header">Property</div>
                                                                <div class="before-header">
                                                                    <mat-icon color="warn">remove_circle</mat-icon>
                                                                    <span>Before</span>
                                                                </div>
                                                                <div class="current-header"
                                                                    *ngIf="hasResourceDrift(selectedResource.address)">
                                                                    <mat-icon color="primary">present_to_all</mat-icon>
                                                                    <span>Current</span>
                                                                </div>
                                                                <div class="after-header">
                                                                    <mat-icon color="primary">add_circle</mat-icon>
                                                                    <span>After</span>
                                                                </div>
                                                            </div>

                                                            <div class="property-diff-rows">
                                                                <div *ngFor="
                                    let propDiff of getChangedPropertiesFlatWithDrift(
                                      change.value.before,
                                      change.value.current,
                                      change.value.after
                                    );
                                    trackBy: trackByPropertyDiff
                                  " class="property-diff-row" [class.nested-property]="propDiff.depth > 0"
                                                                    [class.three-column]="hasResourceDrift(selectedResource.address)"
                                                                    [style.margin-left.px]="propDiff.depth * 20">
                                                                    <div class="property-name">
                                                                        <div class="property-path-container">
                                                                            <span class="property-depth-indicator"
                                                                                *ngIf="propDiff.depth > 0">
                                                                                <mat-icon [style.font-size.px]="12"
                                                                                    [style.color]="'#666'">
                                                                                    subdirectory_arrow_right
                                                                                </mat-icon>
                                                                            </span>
                                                                            <code
                                                                                class="property-key">{{ propDiff.key }}</code>
                                                                            <span class="array-indicator" *ngIf="
                                          propDiff.key.startsWith('[') && propDiff.key.endsWith(']')
                                        ">
                                                                                <mat-icon [style.font-size.px]="10"
                                                                                    [style.color]="'#9c27b0'">view_list</mat-icon>
                                                                            </span>
                                                                        </div>
                                                                        <div class="property-type-info">
                                                                        </div>
                                                                    </div>
                                                                    <div class="property-before-value">
                                                                        <div class="value-display before-value">
                                                                            <div *ngIf="
                                          propDiff.before === null || propDiff.before === undefined
                                        " class="null-value">
                                                                                <em>null</em>
                                                                            </div>
                                                                            <pre *ngIf="
                                          propDiff.before !== null &&
                                          propDiff.before !== undefined &&
                                          isComplexValue(propDiff.before)
                                        " class="json-content">{{ showShortComplexValue(propDiff.before)}}</pre>
                                                                            <code *ngIf="
                                          propDiff.before !== null &&
                                          propDiff.before !== undefined &&
                                          !isComplexValue(propDiff.before)
                                        " class="simple-value">{{ formatSensitiveValue(propDiff.before, selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'before') }}</code>
                                                                            <div class="sensitive-value-actions"
                                                                                *ngIf="isPropertySensitive(selectedResource, buildFullPropertyPath(change.key, propDiff.path)) && propDiff.before !== null && propDiff.before !== undefined">
                                                                                <button mat-icon-button
                                                                                    class="sensitive-copy-btn"
                                                                                    (click)="copySensitiveValueToClipboard(propDiff.before, selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'before')"
                                                                                    matTooltip="Copy sensitive value to clipboard">
                                                                                    <mat-icon>content_copy</mat-icon>
                                                                                </button>
                                                                                <button mat-icon-button
                                                                                    class="sensitive-toggle-btn"
                                                                                    (click)="toggleSensitiveValueVisibility(selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'before')"
                                                                                    [matTooltip]="isSensitiveValueVisible(selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'before') ? 'Hide sensitive value' : 'Show sensitive value'">
                                                                                    <mat-icon>{{
                                                                                        isSensitiveValueVisible(selectedResource,
                                                                                        buildFullPropertyPath(change.key,
                                                                                        propDiff.path), 'before') ?
                                                                                        'visibility_off' : 'visibility'
                                                                                        }}</mat-icon>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="property-current-value"
                                                                        *ngIf="hasResourceDrift(selectedResource.address)">
                                                                        <div class="value-display current-value"
                                                                            [class.drifted]="propDiff.hasDrift">
                                                                            <div *ngIf="
                                          propDiff.current === null || propDiff.current === undefined
                                        " class="null-value">
                                                                                <em>null</em>
                                                                            </div>
                                                                            <pre *ngIf="
                                          propDiff.current !== null &&
                                          propDiff.current !== undefined &&
                                          isComplexValue(propDiff.current)
                                        " class="json-content">{{ showShortComplexValue(propDiff.current) }}</pre>
                                                                            <code *ngIf="
                                          propDiff.current !== null &&
                                          propDiff.current !== undefined &&
                                          !isComplexValue(propDiff.current)
                                        " class="simple-value">{{ formatSensitiveValue(propDiff.current, selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'current') }}</code>
                                                                            <div class="sensitive-value-actions"
                                                                                *ngIf="isPropertySensitive(selectedResource, buildFullPropertyPath(change.key, propDiff.path)) && propDiff.current !== null && propDiff.current !== undefined">
                                                                                <button mat-icon-button
                                                                                    class="sensitive-copy-btn"
                                                                                    (click)="copySensitiveValueToClipboard(propDiff.current, selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'current')"
                                                                                    matTooltip="Copy sensitive value to clipboard">
                                                                                    <mat-icon>content_copy</mat-icon>
                                                                                </button>
                                                                                <button mat-icon-button
                                                                                    class="sensitive-toggle-btn"
                                                                                    (click)="toggleSensitiveValueVisibility(selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'current')"
                                                                                    [matTooltip]="isSensitiveValueVisible(selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'current') ? 'Hide sensitive value' : 'Show sensitive value'">
                                                                                    <mat-icon>{{
                                                                                        isSensitiveValueVisible(selectedResource,
                                                                                        buildFullPropertyPath(change.key,
                                                                                        propDiff.path), 'current') ?
                                                                                        'visibility_off' : 'visibility'
                                                                                        }}</mat-icon>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="property-after-value">
                                                                        <div class="value-display after-value">
                                                                            <div *ngIf="
                                          propDiff.after === null || propDiff.after === undefined
                                        " class="null-value">
                                                                                <em>null</em>
                                                                            </div>
                                                                            <pre *ngIf="
                                          propDiff.after !== null &&
                                          propDiff.after !== undefined &&
                                          isComplexValue(propDiff.after)
                                        " class="json-content">{{ showShortComplexValue(propDiff.after) }}</pre>
                                                                            <code *ngIf="
                                          propDiff.after !== null &&
                                          propDiff.after !== undefined &&
                                          !isComplexValue(propDiff.after)
                                        " class="simple-value">{{ formatSensitiveValue(propDiff.after, selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'after') }}</code>
                                                                            <div class="sensitive-value-actions"
                                                                                *ngIf="isPropertySensitive(selectedResource, buildFullPropertyPath(change.key, propDiff.path)) && propDiff.after !== null && propDiff.after !== undefined">
                                                                                <button mat-icon-button
                                                                                    class="sensitive-copy-btn"
                                                                                    (click)="copySensitiveValueToClipboard(propDiff.after, selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'after')"
                                                                                    matTooltip="Copy sensitive value to clipboard">
                                                                                    <mat-icon>content_copy</mat-icon>
                                                                                </button>
                                                                                <button mat-icon-button
                                                                                    class="sensitive-toggle-btn"
                                                                                    (click)="toggleSensitiveValueVisibility(selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'after')"
                                                                                    [matTooltip]="isSensitiveValueVisible(selectedResource, buildFullPropertyPath(change.key, propDiff.path), 'after') ? 'Hide sensitive value' : 'Show sensitive value'">
                                                                                    <mat-icon>{{
                                                                                        isSensitiveValueVisible(selectedResource,
                                                                                        buildFullPropertyPath(change.key,
                                                                                        propDiff.path), 'after') ?
                                                                                        'visibility_off' : 'visibility'
                                                                                        }}</mat-icon>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Simple before/current/after comparison for non-objects -->
                                                    <ng-template #simpleComparisonWithDrift>
                                                        <div class="simple-diff-container">
                                                            <div class="diff-header">
                                                                <h5>
                                                                    <mat-icon color="accent">compare_arrows</mat-icon>
                                                                    Value Change
                                                                    <span
                                                                        *ngIf="change.value.hasDrift && hasResourceDrift(selectedResource.address)"
                                                                        class="drift-indicator">
                                                                        <mat-icon color="primary"
                                                                            [matTooltip]="'Current state differs from planned state'">info</mat-icon>
                                                                        Drift Detected
                                                                    </span>
                                                                </h5>
                                                            </div>

                                                            <div class="simple-value-diff"
                                                                [class.three-column]="hasResourceDrift(selectedResource.address)">
                                                                <div class="value-diff-row">
                                                                    <div class="before-section">
                                                                        <div class="section-label">
                                                                            <mat-icon
                                                                                color="warn">remove_circle</mat-icon>
                                                                            <span>Before</span>
                                                                        </div>
                                                                        <div class="value-container before-value">
                                                                            <pre *ngIf="isComplexValue(change.value.before)"
                                                                                class="json-content">{{ formatSensitiveValue(change.value.before, selectedResource, change.key, 'before') }}</pre>
                                                                            <code
                                                                                *ngIf="!isComplexValue(change.value.before)"
                                                                                class="simple-value">{{ formatSensitiveValue(change.value.before, selectedResource, change.key, 'before') }}</code>
                                                                            <div class="sensitive-value-actions"
                                                                                *ngIf="isPropertySensitive(selectedResource, change.key) && change.value.before !== null && change.value.before !== undefined">
                                                                                <button mat-icon-button
                                                                                    class="sensitive-copy-btn"
                                                                                    (click)="copySensitiveValueToClipboard(change.value.before, selectedResource, change.key, 'before')"
                                                                                    matTooltip="Copy sensitive value to clipboard">
                                                                                    <mat-icon>content_copy</mat-icon>
                                                                                </button>
                                                                                <button mat-icon-button
                                                                                    class="sensitive-toggle-btn"
                                                                                    (click)="toggleSensitiveValueVisibility(selectedResource, change.key, 'before')"
                                                                                    [matTooltip]="isSensitiveValueVisible(selectedResource, change.key, 'before') ? 'Hide sensitive value' : 'Show sensitive value'">
                                                                                    <mat-icon>{{
                                                                                        isSensitiveValueVisible(selectedResource,
                                                                                        change.key, 'before') ?
                                                                                        'visibility_off' : 'visibility'
                                                                                        }}</mat-icon>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="current-section"
                                                                        *ngIf="hasResourceDrift(selectedResource.address)">
                                                                        <div class="section-label">
                                                                            <mat-icon
                                                                                color="primary">present_to_all</mat-icon>
                                                                            <span>Current</span>
                                                                        </div>
                                                                        <div class="value-container current-value"
                                                                            [class.drifted]="change.value.hasDrift">
                                                                            <pre *ngIf="isComplexValue(change.value.current)"
                                                                                class="json-content">{{ formatSensitiveValue(change.value.current, selectedResource, change.key, 'current') }}</pre>
                                                                            <code
                                                                                *ngIf="!isComplexValue(change.value.current)"
                                                                                class="simple-value">{{ formatSensitiveValue(change.value.current, selectedResource, change.key, 'current') }}</code>
                                                                            <div class="sensitive-value-actions"
                                                                                *ngIf="isPropertySensitive(selectedResource, change.key) && change.value.current !== null && change.value.current !== undefined">
                                                                                <button mat-icon-button
                                                                                    class="sensitive-copy-btn"
                                                                                    (click)="copySensitiveValueToClipboard(change.value.current, selectedResource, change.key, 'current')"
                                                                                    matTooltip="Copy sensitive value to clipboard">
                                                                                    <mat-icon>content_copy</mat-icon>
                                                                                </button>
                                                                                <button mat-icon-button
                                                                                    class="sensitive-toggle-btn"
                                                                                    (click)="toggleSensitiveValueVisibility(selectedResource, change.key, 'current')"
                                                                                    [matTooltip]="isSensitiveValueVisible(selectedResource, change.key, 'current') ? 'Hide sensitive value' : 'Show sensitive value'">
                                                                                    <mat-icon>{{
                                                                                        isSensitiveValueVisible(selectedResource,
                                                                                        change.key, 'current') ?
                                                                                        'visibility_off' : 'visibility'
                                                                                        }}</mat-icon>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>

                                                                    <div class="arrow-separator"
                                                                        *ngIf="!hasResourceDrift(selectedResource.address)">
                                                                        <mat-icon
                                                                            color="primary">arrow_forward</mat-icon>
                                                                    </div>

                                                                    <div class="after-section">
                                                                        <div class="section-label">
                                                                            <mat-icon
                                                                                color="primary">add_circle</mat-icon>
                                                                            <span>After</span>
                                                                        </div>
                                                                        <div class="value-container after-value">
                                                                            <pre *ngIf="isComplexValue(change.value.after)"
                                                                                class="json-content">{{ formatSensitiveValue(change.value.after, selectedResource, change.key, 'after') }}</pre>
                                                                            <code
                                                                                *ngIf="!isComplexValue(change.value.after)"
                                                                                class="simple-value">{{ formatSensitiveValue(change.value.after, selectedResource, change.key, 'after') }}</code>
                                                                            <div class="sensitive-value-actions"
                                                                                *ngIf="isPropertySensitive(selectedResource, change.key) && change.value.after !== null && change.value.after !== undefined">
                                                                                <button mat-icon-button
                                                                                    class="sensitive-copy-btn"
                                                                                    (click)="copySensitiveValueToClipboard(change.value.after, selectedResource, change.key, 'after')"
                                                                                    matTooltip="Copy sensitive value to clipboard">
                                                                                    <mat-icon>content_copy</mat-icon>
                                                                                </button>
                                                                                <button mat-icon-button
                                                                                    class="sensitive-toggle-btn"
                                                                                    (click)="toggleSensitiveValueVisibility(selectedResource, change.key, 'after')"
                                                                                    [matTooltip]="isSensitiveValueVisible(selectedResource, change.key, 'after') ? 'Hide sensitive value' : 'Show sensitive value'">
                                                                                    <mat-icon>{{
                                                                                        isSensitiveValueVisible(selectedResource,
                                                                                        change.key, 'after') ?
                                                                                        'visibility_off' : 'visibility'
                                                                                        }}</mat-icon>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </ng-template>
                                                </div>

                                                <!-- Show current value for unchanged fields -->
                                                <div class="current-value"
                                                    *ngIf="!change.value.changed && !change.value.hasDrift">
                                                    <h5>Current Value</h5>
                                                    <div class="value-container">
                                                        <pre *ngIf="isComplexValue(change.value.after)"
                                                            class="json-content">{{
                              formatSensitiveValue(change.value.after, selectedResource, change.key, 'after')
                            }}</pre>
                                                        <code *ngIf="!isComplexValue(change.value.after)"
                                                            class="simple-value">{{
                              formatSensitiveValue(change.value.after, selectedResource, change.key, 'after')
                            }}</code>
                                                        <button
                                                            *ngIf="isPropertySensitive(selectedResource, change.key) && change.value.after !== null && change.value.after !== undefined"
                                                            mat-icon-button class="sensitive-toggle-btn"
                                                            (click)="toggleSensitiveValueVisibility(selectedResource, change.key, 'after')"
                                                            [matTooltip]="isSensitiveValueVisible(selectedResource, change.key, 'after') ? 'Hide sensitive value' : 'Show sensitive value'">
                                                            <mat-icon>{{ isSensitiveValueVisible(selectedResource,
                                                                change.key, 'after') ? 'visibility_off' : 'visibility'
                                                                }}</mat-icon>
                                                        </button>
                                                    </div>
                                                </div>
                                            </mat-expansion-panel>
                                        </mat-accordion>
                                    </div>
                                </div>

                                <!-- No Changes - Show Current Property Values -->
                                <div *ngIf="!hasChanges(selectedResource)" class="unchanged-resource-details">
                                    <div class="section-header">
                                        <mat-icon color="primary">check_circle</mat-icon>
                                        <h4>Current Resource Properties</h4>
                                    </div>
                                    <p class="info-message">This resource has no planned changes. Showing current state:
                                    </p>

                                    <div class="property-list">
                                        <mat-accordion multi>
                                            <mat-expansion-panel
                                                *ngFor="let change of getSortedChangedFields(selectedResource); trackBy: trackByFieldKey"
                                                class="property-panel">
                                                <mat-expansion-panel-header>
                                                    <mat-panel-title class="property-title">
                                                        <code>{{ change.key }}</code>
                                                    </mat-panel-title>
                                                    <mat-panel-description class="property-description">
                                                        <span class="type-badge">{{ getValueType(change.value.after)
                                                            }}</span>
                                                    </mat-panel-description>
                                                </mat-expansion-panel-header>

                                                <div class="current-value">
                                                    <div class="value-container">
                                                        <pre *ngIf="isComplexValue(change.value.after)"
                                                            class="json-content">{{
                              formatSensitiveValue(change.value.after, selectedResource, change.key, 'after')
                            }}</pre>
                                                        <code *ngIf="!isComplexValue(change.value.after)"
                                                            class="simple-value">{{
                              formatSensitiveValue(change.value.after, selectedResource, change.key, 'after')
                            }}</code>
                                                        <div class="sensitive-value-actions"
                                                            *ngIf="isPropertySensitive(selectedResource, change.key) && change.value.after !== null && change.value.after !== undefined">
                                                            <button mat-icon-button class="sensitive-copy-btn"
                                                                (click)="copySensitiveValueToClipboard(change.value.after, selectedResource, change.key, 'after')"
                                                                matTooltip="Copy sensitive value to clipboard">
                                                                <mat-icon>content_copy</mat-icon>
                                                            </button>
                                                            <button mat-icon-button class="sensitive-toggle-btn"
                                                                (click)="toggleSensitiveValueVisibility(selectedResource, change.key, 'after')"
                                                                [matTooltip]="isSensitiveValueVisible(selectedResource, change.key, 'after') ? 'Hide sensitive value' : 'Show sensitive value'">
                                                                <mat-icon>{{ isSensitiveValueVisible(selectedResource,
                                                                    change.key, 'after') ? 'visibility_off' :
                                                                    'visibility'
                                                                    }}</mat-icon>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </mat-expansion-panel>
                                        </mat-accordion>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Outputs Tab -->
            <mat-tab label="Outputs ({{ allOutputs.length }})">
                <div class="tab-content">
                    <div class="filter-controls">
                        <mat-form-field appearance="outline" class="filter-field">
                            <mat-label>Filter by Name</mat-label>
                            <input matInput [(ngModel)]="outputNameFilter" (input)="applyOutputFilter()"
                                placeholder="Search outputs...">
                        </mat-form-field>
                        <button mat-raised-button (click)="clearOutputFilters()" *ngIf="outputNameFilter">
                            Clear Filters
                        </button>
                    </div>

                    <table mat-table [dataSource]="filteredOutputs" class="outputs-table">
                        <ng-container matColumnDef="key">
                            <th mat-header-cell *matHeaderCellDef>Name</th>
                            <td mat-cell *matCellDef="let output">{{ output.key }}</td>
                        </ng-container>

                        <ng-container matColumnDef="type">
                            <th mat-header-cell *matHeaderCellDef>Type</th>
                            <td mat-cell *matCellDef="let output">
                                <mat-chip class="type-chip">{{ output.type }}</mat-chip>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="sensitive">
                            <th mat-header-cell *matHeaderCellDef>Sensitive</th>
                            <td mat-cell *matCellDef="let output">
                                <mat-icon *ngIf="output.sensitive" class="sensitive-icon">lock</mat-icon>
                                <span *ngIf="!output.sensitive">-</span>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="value">
                            <th mat-header-cell *matHeaderCellDef>Value</th>
                            <td mat-cell *matCellDef="let output">
                                <code *ngIf="!output.sensitive" class="value-code">{{ output.value | json }}</code>
                                <span *ngIf="output.sensitive" class="sensitive-value">(sensitive)</span>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumnsOutputs"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumnsOutputs"></tr>
                    </table>
                </div>
            </mat-tab>

            <!-- Variables Tab -->
            <mat-tab label="Variables ({{ allVariables.length }})">
                <div class="tab-content">
                    <div class="filter-controls">
                        <mat-form-field appearance="outline" class="filter-field">
                            <mat-label>Filter by Name</mat-label>
                            <input matInput [(ngModel)]="variableNameFilter" (input)="applyVariableFilter()"
                                placeholder="Search names...">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="filter-field">
                            <mat-label>Filter by Value</mat-label>
                            <input matInput [(ngModel)]="variableValueFilter" (input)="applyVariableFilter()"
                                placeholder="Search values...">
                        </mat-form-field>
                        <button mat-raised-button (click)="clearVariableFilters()"
                            *ngIf="variableNameFilter || variableValueFilter">
                            Clear Filters
                        </button>
                    </div>

                    <table mat-table [dataSource]="filteredVariables" class="variables-table">
                        <ng-container matColumnDef="key">
                            <th mat-header-cell *matHeaderCellDef>Name</th>
                            <td mat-cell *matCellDef="let variable">{{ variable.key }}</td>
                        </ng-container>

                        <ng-container matColumnDef="type">
                            <th mat-header-cell *matHeaderCellDef>Type</th>
                            <td mat-cell *matCellDef="let variable">
                                <mat-chip class="type-chip">{{ variable.type }}</mat-chip>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="value">
                            <th mat-header-cell *matHeaderCellDef>Value</th>
                            <td mat-cell *matCellDef="let variable">
                                <code class="value-code">{{ variable.value | json }}</code>
                            </td>
                        </ng-container>

                        <tr mat-header-row *matHeaderRowDef="displayedColumnsVariables"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumnsVariables"></tr>
                    </table>
                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-card>
</div>