<mat-toolbar color="primary">
  <mat-icon>cloud</mat-icon>
  <span>Terraform Plan Viewer</span>
  <span class="spacer"></span>
  <button mat-raised-button color="accent" (click)="fileInput.click()">
    <mat-icon>upload_file</mat-icon>
    Load Plan JSON
  </button>
  <input
    #fileInput
    type="file"
    (change)="onFileSelected($event)"
    accept=".json"
    style="display: none"
  />
</mat-toolbar>

<div class="container" *ngIf="!plan">
  <mat-card class="welcome-card">
    <mat-card-header>
      <mat-card-title>Welcome to Terraform Plan Viewer</mat-card-title>
      <mat-card-subtitle>Load a Terraform plan JSON file to get started</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <p>Upload your Terraform plan JSON file to visualize:</p>
      <ul>
        <li>Variables and their values</li>
        <li>Planned outputs</li>
        <li>Resource changes</li>
        <li>Resource relationships</li>
      </ul>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="fileInput.click()">
        <mat-icon>upload_file</mat-icon>
        Choose File
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<div class="container split-layout-container" *ngIf="plan">
  <!-- Plan Overview -->
  <mat-card class="overview-card">
    <mat-card-header>
      <mat-card-title>Plan Overview</mat-card-title>
      <mat-card-subtitle
        >Terraform {{ plan.terraform_version }} â€¢ Format
        {{ plan.format_version }}</mat-card-subtitle
      >
    </mat-card-header>
    <mat-card-content>
      <div class="stats-grid">
        <div class="stat-item create clickable-stat" (click)="onStatButtonClick('create')">
          <mat-icon>add_circle</mat-icon>
          <div class="stat-content">
            <div class="stat-number">{{ resourceSummary.create }}</div>
            <div class="stat-label">Create</div>
          </div>
        </div>
        <div class="stat-item update clickable-stat" (click)="onStatButtonClick('update')">
          <mat-icon>edit</mat-icon>
          <div class="stat-content">
            <div class="stat-number">{{ resourceSummary.update }}</div>
            <div class="stat-label">Update</div>
          </div>
        </div>
        <div class="stat-item delete clickable-stat" (click)="onStatButtonClick('delete')">
          <mat-icon>delete</mat-icon>
          <div class="stat-content">
            <div class="stat-number">{{ resourceSummary.delete }}</div>
            <div class="stat-label">Delete</div>
          </div>
        </div>
        <div class="stat-item replace clickable-stat" (click)="onStatButtonClick('replace')">
          <mat-icon>swap_horiz</mat-icon>
          <div class="stat-content">
            <div class="stat-number">{{ resourceSummary.replace }}</div>
            <div class="stat-label">Replace</div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Main Content Tabs -->
  <mat-tab-group class="main-tabs" #tabGroup>
    <!-- Resource Changes Tab -->
    <mat-tab label="Resource Changes">
      <div class="tab-content split-layout">
        <!-- Filter Controls -->
        <mat-card class="filter-card" *ngIf="activeResourceFilter">
          <mat-card-content>
            <div class="filter-controls">
              <mat-chip-set>
                <mat-chip
                  [style.background-color]="getActionColor([activeResourceFilter])"
                  [style.color]="'white'"
                  [removable]="true"
                  (removed)="clearResourceFilter()"
                >
                  <mat-icon [style.font-size]="'16px'">{{
                    getActionIcon([activeResourceFilter])
                  }}</mat-icon>
                  Showing {{ activeResourceFilter }} resources
                  <mat-icon matChipRemove>cancel</mat-icon>
                </mat-chip>
              </mat-chip-set>
              <div class="results-info">
                <span>Showing {{ getFilteredResourceCount() }} resources</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Split Layout Container -->
        <div class="split-container">
          <!-- Left Panel - Resource List -->
          <div class="left-panel">
            <mat-accordion
              *ngFor="
                let entry of getFilteredResourcesByType() | keyvalue;
                trackBy: trackByResourceType
              "
            >
              <mat-expansion-panel>
                <mat-expansion-panel-header>
                  <mat-panel-title>{{ getResourceTypeDisplayName(entry.key) }}</mat-panel-title>
                  <mat-panel-description>{{ entry.value.length }} resources</mat-panel-description>
                </mat-expansion-panel-header>

                <div class="resource-list">
                  <div
                    *ngFor="let resource of entry.value"
                    class="resource-item"
                    [class.selected]="isResourceSelected(resource)"
                    (click)="selectResource(resource)"
                  >
                    <div class="resource-header">
                      <div class="resource-address">
                        <code>{{ resource.address }}</code>
                      </div>
                      <div class="resource-actions">
                        <mat-chip
                          *ngFor="let action of resource.change.actions"
                          [style.background-color]="getActionColor([action])"
                          [style.color]="'white'"
                          class="action-chip"
                        >
                          <mat-icon [style.font-size]="'14px'">{{
                            getActionIcon([action])
                          }}</mat-icon>
                          {{ action }}
                        </mat-chip>
                      </div>
                    </div>
                    <div class="resource-meta">
                      <span class="resource-type">{{ resource.type }}</span>
                      <span class="resource-provider">{{ resource.provider_name }}</span>
                    </div>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-accordion>
          </div>

          <!-- Right Panel - Resource Details -->
          <div class="right-panel">
            <div *ngIf="!selectedResource" class="no-selection">
              <mat-icon class="large-icon">info</mat-icon>
              <h3>Select a Resource</h3>
              <p>Click on a resource from the left panel to view its detailed changes.</p>
            </div>

            <div *ngIf="selectedResource" class="resource-details">
              <!-- Resource Header -->
              <div class="detail-header">
                <h3>
                  <code>{{ selectedResource.address }}</code>
                </h3>
                <div class="resource-info-bar">
                  <mat-chip>{{ selectedResource.type }}</mat-chip>
                  <span class="provider-name">{{ selectedResource.provider_name }}</span>
                </div>
              </div>

              <!-- Change Details Section -->
              <div class="change-details" *ngIf="hasChanges(selectedResource)">
                <h4>
                  <mat-icon>compare_arrows</mat-icon>
                  Change Details
                </h4>

                <!-- Actions Summary -->
                <div class="actions-summary">
                  <mat-chip-set>
                    <mat-chip
                      *ngFor="let action of selectedResource.change.actions"
                      [style.background-color]="getActionColor([action])"
                      [style.color]="'white'"
                    >
                      <mat-icon [style.font-size]="'16px'">{{ getActionIcon([action]) }}</mat-icon>
                      {{ action }}
                    </mat-chip>
                  </mat-chip-set>
                </div>

                <!-- Field Changes -->
                <div class="field-changes">
                  <mat-accordion>
                    <mat-expansion-panel
                      *ngFor="
                        let change of getSortedChangedFields(selectedResource);
                        trackBy: trackByFieldChange
                      "
                      [class.changed-field]="change.value.changed"
                    >
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-icon
                            [style.color]="change.value.changed ? '#ff9800' : '#4caf50'"
                            [style.margin-right.px]="8"
                          >
                            {{ change.value.changed ? 'edit' : 'check_circle' }}
                          </mat-icon>
                          <code class="field-name">{{ change.key }}</code>
                        </mat-panel-title>
                        <mat-panel-description>
                          {{ change.value.changed ? 'Modified' : 'Unchanged' }}
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      <div class="change-comparison" *ngIf="change.value.changed">
                        <!-- Object property differences (only show changed properties) -->
                        <div
                          *ngIf="
                            shouldShowObjectDiff(change.value.before, change.value.after);
                            else simpleComparison
                          "
                          class="object-diff-container"
                        >
                          <div class="diff-header">
                            <h5>
                              <mat-icon color="accent">data_object</mat-icon>
                              Property Changes
                            </h5>
                          </div>

                          <div class="object-property-diff">
                            <div class="property-diff-header">
                              <div class="property-name-header">Property</div>
                              <div class="before-header">
                                <mat-icon color="warn">remove_circle</mat-icon>
                                <span>Before</span>
                              </div>
                              <div class="after-header">
                                <mat-icon color="primary">add_circle</mat-icon>
                                <span>After</span>
                              </div>
                            </div>

                            <div class="property-diff-rows">
                              <div
                                *ngFor="
                                  let propDiff of getChangedPropertiesFlat(
                                    change.value.before,
                                    change.value.after
                                  );
                                  trackBy: trackByPropertyDiff
                                "
                                class="property-diff-row"
                                [class.nested-property]="propDiff.depth > 0"
                                [style.margin-left.px]="propDiff.depth * 20"
                              >
                                <div class="property-name">
                                  <div class="property-path-container">
                                    <span
                                      class="property-depth-indicator"
                                      *ngIf="propDiff.depth > 0"
                                    >
                                      <mat-icon [style.font-size.px]="12" [style.color]="'#666'">
                                        subdirectory_arrow_right
                                      </mat-icon>
                                    </span>
                                    <code class="property-key">{{ propDiff.key }}</code>
                                    <span
                                      class="property-path"
                                      *ngIf="propDiff.depth > 0"
                                      title="{{ propDiff.path }}"
                                    >
                                      <small>({{ propDiff.path }})</small>
                                    </span>
                                    <span
                                      class="array-indicator"
                                      *ngIf="
                                        propDiff.key.startsWith('[') && propDiff.key.endsWith(']')
                                      "
                                    >
                                      <mat-icon [style.font-size.px]="10" [style.color]="'#9c27b0'"
                                        >view_list</mat-icon
                                      >
                                    </span>
                                  </div>
                                  <div class="property-type-info">
                                    <mat-chip
                                      *ngIf="propDiff.isNested"
                                      class="type-chip nested-type"
                                      [style.background-color]="'#607d8b'"
                                      [style.color]="'white'"
                                    >
                                      <mat-icon [style.font-size.px]="12">data_object</mat-icon>
                                      object
                                    </mat-chip>
                                  </div>
                                </div>
                                <div class="property-before-value">
                                  <div class="value-display before-value">
                                    <div
                                      *ngIf="
                                        propDiff.before === null || propDiff.before === undefined
                                      "
                                      class="null-value"
                                    >
                                      <em>null</em>
                                    </div>
                                    <pre
                                      *ngIf="
                                        propDiff.before !== null &&
                                        propDiff.before !== undefined &&
                                        isComplexValue(propDiff.before)
                                      "
                                      class="json-content"
                                      >{{ formatChangeValue(propDiff.before) }}</pre
                                    >
                                    <code
                                      *ngIf="
                                        propDiff.before !== null &&
                                        propDiff.before !== undefined &&
                                        !isComplexValue(propDiff.before)
                                      "
                                      class="simple-value"
                                      >{{ formatChangeValue(propDiff.before) }}</code
                                    >
                                  </div>
                                </div>
                                <div class="property-after-value">
                                  <div class="value-display after-value">
                                    <div
                                      *ngIf="
                                        propDiff.after === null || propDiff.after === undefined
                                      "
                                      class="null-value"
                                    >
                                      <em>null</em>
                                    </div>
                                    <pre
                                      *ngIf="
                                        propDiff.after !== null &&
                                        propDiff.after !== undefined &&
                                        isComplexValue(propDiff.after)
                                      "
                                      class="json-content"
                                      >{{ formatChangeValue(propDiff.after) }}</pre
                                    >
                                    <code
                                      *ngIf="
                                        propDiff.after !== null &&
                                        propDiff.after !== undefined &&
                                        !isComplexValue(propDiff.after)
                                      "
                                      class="simple-value"
                                      >{{ formatChangeValue(propDiff.after) }}</code
                                    >
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Simple before/after comparison for non-objects -->
                        <ng-template #simpleComparison>
                          <div class="simple-diff-container">
                            <div class="diff-header">
                              <h5>
                                <mat-icon color="accent">compare_arrows</mat-icon>
                                Value Change
                              </h5>
                            </div>

                            <div class="simple-value-diff">
                              <div class="value-diff-row">
                                <div class="before-section">
                                  <div class="section-label">
                                    <mat-icon color="warn">remove_circle</mat-icon>
                                    <span>Before</span>
                                  </div>
                                  <div class="value-container before-value">
                                    <pre
                                      *ngIf="isComplexValue(change.value.before)"
                                      class="json-content"
                                      >{{ formatChangeValue(change.value.before) }}</pre
                                    >
                                    <code
                                      *ngIf="!isComplexValue(change.value.before)"
                                      class="simple-value"
                                      >{{ formatChangeValue(change.value.before) }}</code
                                    >
                                  </div>
                                </div>

                                <div class="arrow-separator">
                                  <mat-icon color="primary">arrow_forward</mat-icon>
                                </div>

                                <div class="after-section">
                                  <div class="section-label">
                                    <mat-icon color="primary">add_circle</mat-icon>
                                    <span>After</span>
                                  </div>
                                  <div class="value-container after-value">
                                    <pre
                                      *ngIf="isComplexValue(change.value.after)"
                                      class="json-content"
                                      >{{ formatChangeValue(change.value.after) }}</pre
                                    >
                                    <code
                                      *ngIf="!isComplexValue(change.value.after)"
                                      class="simple-value"
                                      >{{ formatChangeValue(change.value.after) }}</code
                                    >
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </ng-template>
                      </div>

                      <!-- Show current value for unchanged fields -->
                      <div class="current-value" *ngIf="!change.value.changed">
                        <h5>Current Value</h5>
                        <div class="value-container">
                          <pre *ngIf="isComplexValue(change.value.after)" class="json-content">{{
                            formatChangeValue(change.value.after)
                          }}</pre>
                          <code *ngIf="!isComplexValue(change.value.after)" class="simple-value">{{
                            formatChangeValue(change.value.after)
                          }}</code>
                        </div>
                      </div>
                    </mat-expansion-panel>
                  </mat-accordion>
                </div>
              </div>

              <!-- Show general resource info for resources without changes -->
              <div class="resource-info" *ngIf="!hasChanges(selectedResource)">
                <h4>
                  <mat-icon>info</mat-icon>
                  Resource Information
                </h4>
                <p class="no-changes-message">
                  <mat-icon color="primary">check_circle</mat-icon>
                  This resource has no configuration changes.
                </p>
                <div class="resource-data">
                  <mat-expansion-panel>
                    <mat-expansion-panel-header>
                      <mat-panel-title>Current Configuration</mat-panel-title>
                    </mat-expansion-panel-header>
                    <pre class="json-content">{{
                      getResourceConfigData(selectedResource) | json
                    }}</pre>
                  </mat-expansion-panel>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </mat-tab>

    <!-- Outputs Tab -->
    <mat-tab label="Planned Outputs">
      <div class="tab-content">
        <!-- Filter Controls -->
        <mat-card class="filter-card">
          <mat-card-content>
            <div class="filter-controls">
              <mat-form-field class="filter-field">
                <mat-label>Filter by output name</mat-label>
                <input
                  matInput
                  [(ngModel)]="outputNameFilter"
                  (input)="applyOutputFilter()"
                  placeholder="Enter output name..."
                />
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>

              <button mat-button color="accent" (click)="clearOutputFilters()">
                <mat-icon>clear</mat-icon>
                Clear Filters
              </button>
            </div>

            <div class="results-info">
              <span
                >Showing {{ filteredOutputs.data.length }} of {{ allOutputs.length }} outputs</span
              >
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Outputs Table -->
        <table mat-table [dataSource]="filteredOutputs" class="outputs-table">
          <ng-container matColumnDef="key">
            <th mat-header-cell *matHeaderCellDef>Output</th>
            <td mat-cell *matCellDef="let output">
              <code>{{ output.key }}</code>
            </td>
          </ng-container>

          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let output">
              <mat-chip
                [style.background-color]="getVariableTypeColor(output.type)"
                [style.color]="'white'"
              >
                <mat-icon [style.font-size]="'16px'">{{
                  getVariableTypeIcon(output.type)
                }}</mat-icon>
                {{ output.type }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="sensitive">
            <th mat-header-cell *matHeaderCellDef>Sensitive</th>
            <td mat-cell *matCellDef="let output">
              <mat-icon *ngIf="output.sensitive" color="warn">visibility_off</mat-icon>
              <mat-icon *ngIf="!output.sensitive" color="primary">visibility</mat-icon>
            </td>
          </ng-container>

          <ng-container matColumnDef="value">
            <th mat-header-cell *matHeaderCellDef>Value</th>
            <td mat-cell *matCellDef="let output">
              <div class="value-container">
                <div *ngIf="!output.sensitive" class="value-display">
                  <!-- Array values with expand/collapse functionality -->
                  <div *ngIf="isArrayType(output.value)" class="array-value">
                    <button
                      mat-icon-button
                      (click)="toggleArrayExpansion(output.key, 'output')"
                      class="expand-button"
                      [attr.aria-label]="
                        isArrayExpanded(output.key, 'output') ? 'Collapse array' : 'Expand array'
                      "
                    >
                      <mat-icon>{{
                        isArrayExpanded(output.key, 'output') ? 'expand_less' : 'expand_more'
                      }}</mat-icon>
                    </button>
                    <span
                      class="value-text"
                      [class.expanded]="isArrayExpanded(output.key, 'output')"
                      >{{ formatValue(output.value, output.key, 'output') }}</span
                    >
                  </div>

                  <!-- Non-array values -->
                  <span *ngIf="!isArrayType(output.value)" class="value-text">{{
                    formatValue(output.value, output.key, 'output')
                  }}</span>
                </div>
                <span *ngIf="output.sensitive" class="sensitive-value">*** (sensitive) ***</span>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsOutputs"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsOutputs"></tr>
        </table>
      </div>
    </mat-tab>

    <!-- Variables Tab -->
    <mat-tab label="Variables">
      <div class="tab-content">
        <!-- Filter Controls -->
        <mat-card class="filter-card">
          <mat-card-content>
            <div class="filter-controls">
              <mat-form-field class="filter-field">
                <mat-label>Filter by name</mat-label>
                <input
                  matInput
                  [(ngModel)]="variableNameFilter"
                  (input)="applyVariableFilter()"
                  placeholder="Enter variable name..."
                />
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>

              <mat-form-field class="filter-field">
                <mat-label>Filter by value</mat-label>
                <input
                  matInput
                  [(ngModel)]="variableValueFilter"
                  (input)="applyVariableFilter()"
                  placeholder="Enter value..."
                />
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>

              <button mat-button color="accent" (click)="clearVariableFilters()">
                <mat-icon>clear</mat-icon>
                Clear Filters
              </button>
            </div>

            <div class="results-info">
              <span
                >Showing {{ filteredVariables.data.length }} of
                {{ allVariables.length }} variables</span
              >
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Variables Table -->
        <table mat-table [dataSource]="filteredVariables" class="variables-table">
          <ng-container matColumnDef="key">
            <th mat-header-cell *matHeaderCellDef>Variable</th>
            <td mat-cell *matCellDef="let variable">
              <code>{{ variable.key }}</code>
            </td>
          </ng-container>

          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let variable">
              <mat-chip
                [style.background-color]="getVariableTypeColor(variable.type)"
                [style.color]="'white'"
              >
                <mat-icon [style.font-size]="'16px'">{{
                  getVariableTypeIcon(variable.type)
                }}</mat-icon>
                {{ variable.type }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="value">
            <th mat-header-cell *matHeaderCellDef>Value</th>
            <td mat-cell *matCellDef="let variable">
              <div class="value-container">
                <div *ngIf="!variable.isEmpty" class="value-display">
                  <!-- Array values with expand/collapse functionality -->
                  <div *ngIf="isArrayType(variable.value)" class="array-value">
                    <button
                      mat-icon-button
                      (click)="toggleArrayExpansion(variable.key)"
                      class="expand-button"
                      [attr.aria-label]="
                        isArrayExpanded(variable.key) ? 'Collapse array' : 'Expand array'
                      "
                    >
                      <mat-icon>{{
                        isArrayExpanded(variable.key) ? 'expand_less' : 'expand_more'
                      }}</mat-icon>
                    </button>
                    <span class="value-text" [class.expanded]="isArrayExpanded(variable.key)">{{
                      formatValue(variable.value, variable.key, 'variable')
                    }}</span>
                  </div>

                  <!-- Non-array values -->
                  <span *ngIf="!isArrayType(variable.value)" class="value-text">{{
                    formatValue(variable.value, variable.key, 'variable')
                  }}</span>
                </div>
                <span *ngIf="variable.isEmpty" class="empty-value">empty</span>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsVariables"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsVariables"></tr>
        </table>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
