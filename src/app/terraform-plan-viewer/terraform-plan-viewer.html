<mat-toolbar color="primary">
  <mat-icon>cloud</mat-icon>
  <span>Terraform Plan Viewer</span>
  <span class="spacer"></span>
  <button mat-raised-button color="accent" (click)="fileInput.click()">
    <mat-icon>upload_file</mat-icon>
    Load Plan JSON
  </button>
  <input
    #fileInput
    type="file"
    (change)="onFileSelected($event)"
    accept=".json"
    style="display: none"
  />
</mat-toolbar>

<div class="container" *ngIf="!plan">
  <mat-card class="welcome-card">
    <mat-card-header>
      <mat-card-title>Welcome to Terraform Plan Viewer</mat-card-title>
      <mat-card-subtitle>Load a Terraform plan JSON file to get started</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <p>Upload your Terraform plan JSON file to visualize:</p>
      <ul>
        <li>Variables and their values</li>
        <li>Planned outputs</li>
        <li>Resource changes</li>
      </ul>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="fileInput.click()">
        <mat-icon>upload_file</mat-icon>
        Choose File
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<div class="container" *ngIf="plan">
  <!-- Plan Overview -->
  <mat-card class="overview-card">
    <mat-card-header>
      <mat-card-title>Plan Overview</mat-card-title>
      <mat-card-subtitle>Terraform {{ plan.terraform_version }} â€¢ Format {{ plan.format_version }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="stats-grid">
        <div class="stat-item create clickable-stat" (click)="onStatButtonClick('create')">
          <mat-icon>add_circle</mat-icon>
          <div class="stat-content">
            <div class="stat-number">{{ resourceSummary.create }}</div>
            <div class="stat-label">Create</div>
          </div>
        </div>
        <div class="stat-item update clickable-stat" (click)="onStatButtonClick('update')">
          <mat-icon>edit</mat-icon>
          <div class="stat-content">
            <div class="stat-number">{{ resourceSummary.update }}</div>
            <div class="stat-label">Update</div>
          </div>
        </div>
        <div class="stat-item delete clickable-stat" (click)="onStatButtonClick('delete')">
          <mat-icon>delete</mat-icon>
          <div class="stat-content">
            <div class="stat-number">{{ resourceSummary.delete }}</div>
            <div class="stat-label">Delete</div>
          </div>
        </div>
        <div class="stat-item replace clickable-stat" (click)="onStatButtonClick('replace')">
          <mat-icon>swap_horiz</mat-icon>
          <div class="stat-content">
            <div class="stat-number">{{ resourceSummary.replace }}</div>
            <div class="stat-label">Replace</div>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Tabs for different views -->
  <mat-card class="content-card">
    <mat-tab-group #tabGroup>
      <!-- Resources Tab -->
      <mat-tab label="Resources ({{ resourceSummary.total }})">
        <div class="tab-content">
          <!-- Filter indication -->
          <mat-card class="filter-card" *ngIf="activeResourceFilter" style="margin-bottom: 16px;">
            <mat-card-content>
              <div class="filter-controls">
                <mat-chip-set>
                  <mat-chip [style.background-color]="getActionColor([activeResourceFilter])" [style.color]="'white'"
                    [removable]="true" (removed)="clearResourceFilter()">
                    <mat-icon [style.font-size]="'16px'">{{
                      getActionIcon([activeResourceFilter])
                    }}</mat-icon>
                    Showing {{ activeResourceFilter }} resources
                    <mat-icon matChipRemove>cancel</mat-icon>
                  </mat-chip>
                </mat-chip-set>
                <div class="results-info">
                  <span>Showing {{ getFilteredResourceCount() }} resources</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Split Layout Container -->
          <div class="split-container">
            <!-- Left Panel - Resource List -->
            <div class="left-panel">
              <!-- Module Groups -->
              <mat-accordion *ngFor="let moduleGroup of getFilteredModuleGroups(); trackBy: trackByModuleGroup"
                class="module-accordion">
            <mat-expansion-panel class="module-panel">
              <mat-expansion-panel-header>
                <mat-panel-title class="module-title">
                  <mat-icon class="module-icon">folder</mat-icon>
                  {{ moduleGroup.display_name }}
                </mat-panel-title>
                <mat-panel-description class="module-description">
                  {{ moduleGroup.resource_count }} resources
                </mat-panel-description>
              </mat-expansion-panel-header>

              <!-- Resources grouped by type within the module with iterator support -->
              <div class="module-content">
                <mat-accordion *ngFor="
                    let entry of getFilteredResourcesByModuleWithIterators().get(moduleGroup.name) | keyvalue;
                    trackBy: trackByResourceTypeGroup
                  " class="resource-type-accordion">
                  <mat-expansion-panel class="resource-type-panel">
                    <mat-expansion-panel-header>
                      <mat-panel-title class="resource-type-title">
                        {{ entry.value.display_name }}
                      </mat-panel-title>
                      <mat-panel-description class="resource-type-description">
                        {{ entry.value.total_count }} resources
                        <span *ngIf="entry.value.iterator_groups.length > 0" class="iterator-info">
                          ({{ entry.value.iterator_groups.length }} groups)
                        </span>
                      </mat-panel-description>
                    </mat-expansion-panel-header>

                    <!-- Individual resources (non-iterator) -->
                    <div *ngIf="entry.value.resources.length > 0" class="resource-list">
                      <div *ngFor="let resource of entry.value.resources" class="resource-item"
                        [class.selected]="isResourceSelected(resource)" (click)="selectResource(resource)">
                        <div class="resource-header">
                          <div class="resource-address">
                            <code>{{ resource.address }}</code>
                          </div>
                          <div class="resource-actions">
                            <mat-chip *ngFor="let action of resource.change.actions"
                              [style.background-color]="getActionColor([action])" [style.color]="'white'"
                              class="action-chip">
                              <mat-icon [style.font-size]="'14px'">{{
                                getActionIcon([action])
                              }}</mat-icon>
                              {{ action }}
                            </mat-chip>
                          </div>
                        </div>
                        <div class="resource-meta">
                          <span class="resource-type">{{ resource.type }}</span>
                          <span class="resource-provider">{{ resource.provider_name }}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Iterator groups -->
                    <div *ngIf="entry.value.iterator_groups.length > 0" class="iterator-groups">
                      <mat-accordion
                        *ngFor="let iteratorGroup of entry.value.iterator_groups; trackBy: trackByIteratorGroup"
                        class="iterator-group-accordion">
                        <mat-expansion-panel class="iterator-group-panel">
                          <mat-expansion-panel-header>
                            <mat-panel-title class="iterator-group-title">
                              <mat-icon class="iterator-icon">
                                {{ iteratorGroup.iterator_type === 'count' ? 'format_list_numbered' : 'view_list' }}
                              </mat-icon>
                              <code>{{ iteratorGroup.base_address }}</code>
                            </mat-panel-title>
                            <mat-panel-description class="iterator-group-description">
                              {{ iteratorGroup.resources.length }} instances
                              ({{ iteratorGroup.iterator_type }})
                            </mat-panel-description>
                          </mat-expansion-panel-header>

                          <div class="resource-list iterator-resource-list">
                            <div *ngFor="let resource of iteratorGroup.resources"
                              class="resource-item iterator-resource-item"
                              [class.selected]="isResourceSelected(resource)" (click)="selectResource(resource)">
                              <div class="resource-header">
                                <div class="resource-address">
                                  <code>{{ resource.address }}</code>
                                </div>
                                <div class="resource-actions">
                                  <mat-chip *ngFor="let action of resource.change.actions"
                                    [style.background-color]="getActionColor([action])" [style.color]="'white'"
                                    class="action-chip">
                                    <mat-icon [style.font-size]="'14px'">{{
                                      getActionIcon([action])
                                    }}</mat-icon>
                                    {{ action }}
                                  </mat-chip>
                                </div>
                              </div>
                              <div class="resource-meta">
                                <span class="resource-type">{{ resource.type }}</span>
                                <span class="resource-provider">{{ resource.provider_name }}</span>
                              </div>
                            </div>
                          </div>
                        </mat-expansion-panel>
                      </mat-accordion>
                    </div>
                  </mat-expansion-panel>
                </mat-accordion>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
            </div>

            <!-- Right Panel - Resource Details -->
            <div class="right-panel">
              <div *ngIf="!selectedResource" class="no-selection">
                <mat-icon class="large-icon">info</mat-icon>
                <h3>Select a Resource</h3>
                <p>Click on a resource from the left panel to view its detailed changes.</p>
              </div>

              <div *ngIf="selectedResource" class="resource-details">
                <!-- Resource Header -->
                <div class="detail-header">
                  <h3>
                    <code>{{ selectedResource.address }}</code>
                  </h3>
                  <div class="resource-info-bar">
                    <mat-chip>{{ selectedResource.type }}</mat-chip>
                    <span class="provider-name">{{ selectedResource.provider_name }}</span>
                  </div>
                </div>

                <!-- Change Details Section -->
                <div class="change-details" *ngIf="hasChanges(selectedResource)">
                  <h4>
                    <mat-icon>compare_arrows</mat-icon>
                    Change Details
                  </h4>

                  <!-- Actions Summary -->
                  <div class="actions-summary">
                    <div class="actions-chips">
                      <mat-chip-set>
                        <mat-chip *ngFor="let action of selectedResource.change.actions"
                          [style.background-color]="getActionColor([action])" [style.color]="'white'">
                          <mat-icon [style.font-size]="'16px'">{{
                            getActionIcon([action])
                          }}</mat-icon>
                          {{ action }}
                        </mat-chip>
                      </mat-chip-set>
                    </div>
                  </div>

                  <!-- Field Changes -->
                  <div class="field-changes">
                    <mat-accordion>
                      <mat-expansion-panel *ngFor="
                          let change of getSortedChangedFields(selectedResource);
                          trackBy: trackByFieldChange
                        " [class.changed-field]="change.value.changed">
                        <mat-expansion-panel-header>
                          <mat-panel-title>
                            <mat-icon [style.color]="change.value.changed ? '#ff9800' : '#4caf50'"
                              [style.margin-right.px]="8">
                              {{ change.value.changed ? 'edit' : 'check_circle' }}
                            </mat-icon>
                            <code class="field-name">{{ change.key }}</code>
                          </mat-panel-title>
                          <mat-panel-description>
                            {{ change.value.changed ? 'Modified' : 'Unchanged' }}
                          </mat-panel-description>
                        </mat-expansion-panel-header>

                        <div class="change-comparison" *ngIf="change.value.changed">
                          <!-- Object property differences (only show changed properties) -->
                          <div *ngIf="
                              shouldShowObjectDiff(change.value.before, change.value.after);
                              else simpleComparison
                            " class="object-diff-container">
                            <div class="diff-header">
                              <h5>
                                <mat-icon color="accent">data_object</mat-icon>
                                Property Changes
                              </h5>
                            </div>

                            <div class="object-property-diff">
                              <div class="property-diff-header">
                                <div class="property-name-header">Property</div>
                                <div class="before-header">
                                  <mat-icon color="warn">remove_circle</mat-icon>
                                  <span>Before</span>
                                </div>
                                <div class="after-header">
                                  <mat-icon color="primary">add_circle</mat-icon>
                                  <span>After</span>
                                </div>
                              </div>

                              <div class="property-diff-rows">
                                <div *ngFor="
                                    let propDiff of getChangedPropertiesFlat(
                                      change.value.before,
                                      change.value.after
                                    );
                                    trackBy: trackByPropertyDiff
                                  " class="property-diff-row" [class.nested-property]="propDiff.depth > 0"
                                  [style.margin-left.px]="propDiff.depth * 20">
                                  <div class="property-name">
                                    <div class="property-path-container">
                                      <span class="property-depth-indicator" *ngIf="propDiff.depth > 0">
                                        <mat-icon [style.font-size.px]="12" [style.color]="'#666'">
                                          subdirectory_arrow_right
                                        </mat-icon>
                                      </span>
                                      <code class="property-key">{{ propDiff.key }}</code>
                                      <span class="property-path" *ngIf="propDiff.depth > 0" title="{{ propDiff.path }}">
                                        <small>({{ propDiff.path }})</small>
                                      </span>
                                      <span class="array-indicator" *ngIf="
                                          propDiff.key.startsWith('[') && propDiff.key.endsWith(']')
                                        ">
                                        <mat-icon [style.font-size.px]="10" [style.color]="'#9c27b0'">view_list</mat-icon>
                                      </span>
                                    </div>
                                    <div class="property-type-info">
                                      <mat-chip *ngIf="propDiff.isNested" class="type-chip nested-type"
                                        [style.background-color]="'#607d8b'" [style.color]="'white'">
                                        <mat-icon [style.font-size.px]="12">data_object</mat-icon>
                                        object
                                      </mat-chip>
                                    </div>
                                  </div>
                                  <div class="property-before-value">
                                    <div class="value-display before-value">
                                      <div *ngIf="
                                          propDiff.before === null || propDiff.before === undefined
                                        " class="null-value">
                                        <em>null</em>
                                      </div>
                                      <pre *ngIf="
                                          propDiff.before !== null &&
                                          propDiff.before !== undefined &&
                                          isComplexValue(propDiff.before)
                                        " class="json-content">{{ formatChangeValue(propDiff.before) }}</pre>
                                      <code *ngIf="
                                          propDiff.before !== null &&
                                          propDiff.before !== undefined &&
                                          !isComplexValue(propDiff.before)
                                        " class="simple-value">{{ formatChangeValue(propDiff.before) }}</code>
                                    </div>
                                  </div>
                                  <div class="property-after-value">
                                    <div class="value-display after-value">
                                      <div *ngIf="
                                          propDiff.after === null || propDiff.after === undefined
                                        " class="null-value">
                                        <em>null</em>
                                      </div>
                                      <pre *ngIf="
                                          propDiff.after !== null &&
                                          propDiff.after !== undefined &&
                                          isComplexValue(propDiff.after)
                                        " class="json-content">{{ formatChangeValue(propDiff.after) }}</pre>
                                      <code *ngIf="
                                          propDiff.after !== null &&
                                          propDiff.after !== undefined &&
                                          !isComplexValue(propDiff.after)
                                        " class="simple-value">{{ formatChangeValue(propDiff.after) }}</code>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Simple before/after comparison for non-objects -->
                          <ng-template #simpleComparison>
                            <div class="simple-diff-container">
                              <div class="diff-header">
                                <h5>
                                  <mat-icon color="accent">compare_arrows</mat-icon>
                                  Value Change
                                </h5>
                              </div>

                              <div class="simple-value-diff">
                                <div class="value-diff-row">
                                  <div class="before-section">
                                    <div class="section-label">
                                      <mat-icon color="warn">remove_circle</mat-icon>
                                      <span>Before</span>
                                    </div>
                                    <div class="value-container before-value">
                                      <pre *ngIf="isComplexValue(change.value.before)"
                                        class="json-content">{{ formatChangeValue(change.value.before) }}</pre>
                                      <code *ngIf="!isComplexValue(change.value.before)"
                                        class="simple-value">{{ formatChangeValue(change.value.before) }}</code>
                                    </div>
                                  </div>

                                  <div class="arrow-separator">
                                    <mat-icon color="primary">arrow_forward</mat-icon>
                                  </div>

                                  <div class="after-section">
                                    <div class="section-label">
                                      <mat-icon color="primary">add_circle</mat-icon>
                                      <span>After</span>
                                    </div>
                                    <div class="value-container after-value">
                                      <pre *ngIf="isComplexValue(change.value.after)"
                                        class="json-content">{{ formatChangeValue(change.value.after) }}</pre>
                                      <code *ngIf="!isComplexValue(change.value.after)"
                                        class="simple-value">{{ formatChangeValue(change.value.after) }}</code>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </ng-template>
                        </div>

                        <!-- Show current value for unchanged fields -->
                        <div class="current-value" *ngIf="!change.value.changed">
                          <h5>Current Value</h5>
                          <div class="value-container">
                            <pre *ngIf="isComplexValue(change.value.after)" class="json-content">{{
                              formatChangeValue(change.value.after)
                            }}</pre>
                            <code *ngIf="!isComplexValue(change.value.after)" class="simple-value">{{
                              formatChangeValue(change.value.after)
                            }}</code>
                          </div>
                        </div>
                      </mat-expansion-panel>
                    </mat-accordion>
                  </div>
                </div>

                <!-- No Changes Message -->
                <div *ngIf="!hasChanges(selectedResource)" class="no-changes">
                  <mat-icon>check_circle</mat-icon>
                  <p>This resource has no changes.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </mat-tab>

      <!-- Outputs Tab -->
      <mat-tab label="Outputs ({{ allOutputs.length }})">
        <div class="tab-content">
          <div class="filter-controls">
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Filter by Name</mat-label>
              <input matInput [(ngModel)]="outputNameFilter" (input)="applyOutputFilter()" placeholder="Search outputs...">
            </mat-form-field>
            <button mat-raised-button (click)="clearOutputFilters()" *ngIf="outputNameFilter">
              Clear Filters
            </button>
          </div>

          <table mat-table [dataSource]="filteredOutputs" class="outputs-table">
            <ng-container matColumnDef="key">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let output">{{ output.key }}</td>
            </ng-container>

            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let output">
                <mat-chip class="type-chip">{{ output.type }}</mat-chip>
              </td>
            </ng-container>

            <ng-container matColumnDef="sensitive">
              <th mat-header-cell *matHeaderCellDef>Sensitive</th>
              <td mat-cell *matCellDef="let output">
                <mat-icon *ngIf="output.sensitive" class="sensitive-icon">lock</mat-icon>
                <span *ngIf="!output.sensitive">-</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="value">
              <th mat-header-cell *matHeaderCellDef>Value</th>
              <td mat-cell *matCellDef="let output">
                <code *ngIf="!output.sensitive" class="value-code">{{ output.value | json }}</code>
                <span *ngIf="output.sensitive" class="sensitive-value">(sensitive)</span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumnsOutputs"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsOutputs"></tr>
          </table>
        </div>
      </mat-tab>

      <!-- Variables Tab -->
      <mat-tab label="Variables ({{ allVariables.length }})">
        <div class="tab-content">
          <div class="filter-controls">
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Filter by Name</mat-label>
              <input matInput [(ngModel)]="variableNameFilter" (input)="applyVariableFilter()" placeholder="Search names...">
            </mat-form-field>
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Filter by Value</mat-label>
              <input matInput [(ngModel)]="variableValueFilter" (input)="applyVariableFilter()" placeholder="Search values...">
            </mat-form-field>
            <button mat-raised-button (click)="clearVariableFilters()" *ngIf="variableNameFilter || variableValueFilter">
              Clear Filters
            </button>
          </div>
          
          <table mat-table [dataSource]="filteredVariables" class="variables-table">
            <ng-container matColumnDef="key">
              <th mat-header-cell *matHeaderCellDef>Name</th>
              <td mat-cell *matCellDef="let variable">{{ variable.key }}</td>
            </ng-container>

            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let variable">
                <mat-chip class="type-chip">{{ variable.type }}</mat-chip>
              </td>
            </ng-container>

            <ng-container matColumnDef="value">
              <th mat-header-cell *matHeaderCellDef>Value</th>
              <td mat-cell *matCellDef="let variable">
                <code class="value-code">{{ variable.value | json }}</code>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumnsVariables"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsVariables"></tr>
          </table>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-card>
</div>
